---
title: "Soil Analysis"
description: Soil analysis of soil survey from the North of Thailand
draft: FALSE
categories:
  - Rstat
  - Rice research
author:
  - name: Sith Jaisong
date: 04-20-2021
preview:
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
creative_commons: CC BY
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The project of soil profiles collected from rice planting areas in the north of Thailand was established from 2016 - 2019.
The details will be shown below.

# Reveal of data

```{r message=FALSE, warning=FALSE}
# load library
library(here)
library(tidyverse)
library(tidyr)
library(recipes)
library(corrplot)
library(ggpubr)
library(Rmisc)
library(vegan)
library(ggpubr)
library(GGally)
library(RColorBrewer)

database <- read_csv(
  file = here::here("_posts", "2021-04-20-soil-analysis" ,"data", "database.csv")
  )
#glimpse(database) # if you want to see the original data
```

Then, we should remove columns containing Thai letter due to not supported by R

```{r warning=FALSE, message=FALSE}
database.cleaned <- database %>%
  select(-run,
         -`lab no`,
         -transplant,
         -var,
         -tam,
         -amphoe,
         -prov,
         -seriesname,
         -from) %>%
  mutate(
    pH = as.numeric(pH),
    om = as.numeric(om),
    P = as.numeric(P),
    K = as.numeric(K),
    sand = as.numeric(sand),
    silt = as.numeric(silt),
    clay = as.numeric(clay),
    texture = as.factor(texture),
    soilseries = as.factor(soilseries),
    suit = as.factor(suit),
    text.code = as.factor(text.code),
    se.tex = as.factor(se.tex)
  )
database.cleaned
```

# EDA

Shall we look at data distribution of each variables by histograms.

```{r message=FALSE}
library(DataExplorer)
database.cleaned %>%
  select(pH, om, P, K, sand, clay) %>%
  plot_histogram() + facet_grid(soilseries ~ text.code)
```

Clay, OM, pH and sand were all tend to be normal distributed except K and P. So, in any soil types, pH was not vary.

To compare soil properties in each of suitable soil levels. I would rather to show mean of each factor with 95%CI errorbar.

```{r summary of mean of variabls by suit soil type}
my_sum_suit <- database.cleaned %>%
  select(pH, om, P, K, sand, silt, clay, suit) %>%
  gather(key = "soil_prop", value = "measurement",-suit) %>%
  summarySE(
    measurevar = "measurement",
    groupvars = c("suit", "soil_prop"),
    conf.interval = 0.95,
    na.rm = TRUE,
    .drop = TRUE
  )

my_sum_suit %>% ggplot(aes(x = suit, y = measurement)) +
  geom_point(size = 2) +
  geom_errorbar(width = 0, size = 1, aes(
    ymin = measurement - ci,
    ymax = measurement + ci
  )) +
  facet_wrap(~soil_prop, scales = "free") + theme_bw()
```

Here take a look soil properties at each soil series

```{r}
my_sum_soilseries <- database.cleaned %>%
  select(pH, om, P, K, sand, silt, clay, soilseries, text.code) %>%
  gather(key = "soil_prop", value = "measurement", -soilseries, - text.code) %>%
  summarySE(
    measurevar = "measurement",
    groupvars = c("soilseries", "soil_prop", "text.code"),
    conf.interval = 0.95,
    na.rm = TRUE,
    .drop = TRUE
  )

my_sum_soilseries %>% ggplot(aes(x = soilseries, y = measurement)) +
  geom_point(size = 2) +
  geom_errorbar(width = 0,
                size = 1,
                aes(ymin = measurement - ci,
                    ymax = measurement + ci)) +
  facet_grid(soil_prop ~  text.code , scales = "free") + theme_bw()
```
##Check correlation of each parameters


```{r correlation map, fig.height=6, fig.width=6, message=FALSE}
database.cleaned %>%
  select(pH, om, P, K, sand, clay, suit) %>%
  GGally::ggpairs(aes(color = suit),
          columns = c("pH", "om", 
                      "P", "K", "sand", "clay"))  + scale_color_brewer(palette = "Spectral") +
 scale_fill_brewer(palette = "Spectral")
```

Again!
```{r correlation between variable}
database.cleaned %>%
  select(pH, om, P, K, sand, clay) %>%
  plot_correlation()
```

Again!

```{r}
library(lsr)
library(corrr)

database.cleaned %>% select(pH:clay) %>%
  correlate() %>%
  rearrange() %>%
  shave() %>%
  rplot()

```

pH is not very affected on any factor in soil properties.
om is likely to related to clay, sand, and K.
P is related to K.
K is related to om, and P. sand is negatively related to clay, and om.
clay is related to sand and om.
we can ignore pH in the analysis.

# Intra- and interspecific variation Exploration of soil types

How to find the get fractional of varaince explained from ANOVA which is multiple R square at <https://www.sfu.ca/~jackd/Stat302/Wk07-1_Full.pdf>

```{r}
#follow thai papaer Intra- and interspecific variation in wood density and fine-scale spatial distribution of stand-level wood density in a northern Thai tropical monta

# at pH
lm(pH ~ suit, data = database.cleaned) %>% summary() # check at Multiple R square 0.01164
lm(pH ~ soilseries, data = database.cleaned) %>% summary() # check at Multiple R square 0.08051

# at om
lm(om ~ suit, data = database.cleaned) %>% summary() # check at Multiple R square 0.01851
lm(om ~ soilseries, data = database.cleaned) %>% summary() # check at Multiple R square 0.1442

# at P
lm(log(P) ~ suit, data = database.cleaned) %>% summary() # check at Multiple R square 0.006
lm(log(P) ~ soilseries, data = database.cleaned) %>% summary() # check at Multiple R square 0.096

# at K
lm(log(K) ~ suit, data = database.cleaned) %>% summary() # check at Multiple R square 0.0004
lm(log(K) ~ soilseries, data = database.cleaned) %>% summary() # check at Multiple R square 0.1435

# at clay
lm(clay ~ suit, data = database.cleaned) %>% summary() # check at Multiple R square 0.04
lm(clay ~ soilseries, data = database.cleaned) %>% summary() # check at Multiple R square 0.1495

```


To quantify the extent of intraspecific vs. interspecific variation of soil properties along the soil categories, we performed a variance partitioning analysis.
This analysis assesses the variation in properties at different soil categories (i.e., within-samples, soil series, and soil suit) and between sites (populations) across the elevation gradient.
We log transformed the data for the multiplicative soil properties (i.e., pH, OM, P and K) of all non-experimental samples and performed a nested ANOVA using the lme and varcomp functions in R.

For each level, the function first calculates the group mean.
It then compares the variance around the group mean to the mean of the next level (e.g., variance of suitable soil level is compared to the mean of family level).
We used taxonomy as a substitute for phylogeny in the analysis.
As a result, trait variance may be influenced by the loss of information about the ages of species, genera, families, and orders in relation to each other.

```{r}
library(nlme)
library(ape)

lme(pH ~ 1,
  random = ~ 1 | suit / soilseries,
  data = database.cleaned
) %>% varcomp(., scale = TRUE, cum = FALSE) -> pH_varcomp


lme(om ~ 1,
  random = ~ 1 | suit / soilseries,
  data = database.cleaned
) %>% varcomp(., scale = TRUE, cum = FALSE) -> om_varcomp

# P is not normal distributed
lme(log(P) ~ 1,
  random = ~ 1 | suit / soilseries,
  data = database.cleaned
) %>% varcomp(., scale = TRUE, cum = FALSE) -> p_varcomp

lme(log(K) ~ 1,
  random = ~ 1 | suit / soilseries,
  data = database.cleaned
) %>% varcomp(., scale = TRUE, cum = FALSE) -> k_varcomp

var <- tibble(
  soil_level = c("suit", "soilseries", "within"),
  pH = pH_varcomp * 100,
  OM = om_varcomp * 100,
  P = p_varcomp * 100,
  K = k_varcomp * 100
)

var
```

